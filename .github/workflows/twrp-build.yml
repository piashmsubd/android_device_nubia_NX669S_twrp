name: Build TWRP Recovery

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'TWRP Manifest Branch'
        required: true
        default: 'twrp-12.1'
        type: choice
        options:
          - twrp-12.1
          - twrp-11

jobs:
  build:
    name: Build TWRP by ${{ github.actor }}
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      KERNEL_REPO: piashmsubd/android_kernel_nubia_nx669s_nethunter

    steps:
    - name: Cleanup disk space
      run: |
        sudo rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc
        sudo apt-get clean
        df -h

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ccache curl flex g++-multilib \
          gcc-multilib git gnupg gperf imagemagick libncurses5-dev \
          libncurses5 libssl-dev libxml2 libxml2-utils \
          lzop pngcrush rsync schedtool squashfs-tools xsltproc zip \
          zlib1g-dev python3 python-is-python3 openjdk-11-jdk \
          gcc-aarch64-linux-gnu libelf-dev liblz4-tool

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        max-size: 8G
        key: ccache-twrp-${{ github.event.inputs.MANIFEST_BRANCH }}

    - name: Install repo
      run: |
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        sudo ln -sf ~/bin/repo /usr/bin/repo

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Clone Kernel Source
      run: |
        git clone --depth=1 https://github.com/${{ env.KERNEL_REPO }} kernel

    - name: Build Kernel and DTB
      run: |
        cd kernel
        export ARCH=arm64
        export SUBARCH=arm64
        export CROSS_COMPILE=aarch64-linux-gnu-
        
        # Use default config
        if [ -f arch/arm64/configs/nethunter_NX669S_defconfig ]; then
          make nethunter_NX669S_defconfig
        elif [ -f arch/arm64/configs/vendor/lahaina-qgki_defconfig ]; then
          make vendor/lahaina-qgki_defconfig
        else
          make defconfig
        fi
        
        # Build kernel and dtbs
        make -j$(nproc --all) Image dtbs 2>&1 | tail -100
        
        echo "=== Kernel build output ==="
        find . -name "Image" -o -name "*.dtb" | head -20

    - name: Initialize TWRP repo
      run: |
        mkdir workspace && cd workspace
        repo init --depth=1 -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b ${{ github.event.inputs.MANIFEST_BRANCH }}

    - name: Sync TWRP Source
      run: |
        cd workspace
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

    - name: Clone Device Tree
      run: |
        cd workspace
        git clone --depth=1 https://github.com/${{ github.repository }} -b main device/nubia/NX669S
        
        # Fix nested structure if exists
        if [ -d "device/nubia/NX669S/device/nubia/NX669S" ]; then
          mv device/nubia/NX669S/device/nubia/NX669S/* device/nubia/NX669S/
          rm -rf device/nubia/NX669S/device
        fi

    - name: Copy Kernel to Device Tree
      run: |
        # Copy kernel Image
        if [ -f kernel/arch/arm64/boot/Image ]; then
          cp kernel/arch/arm64/boot/Image workspace/device/nubia/NX669S/prebuilt/kernel
          echo "Kernel copied!"
        fi
        
        # Copy DTBs if available
        mkdir -p workspace/device/nubia/NX669S/prebuilt/dtb
        find kernel -name "*.dtb" -exec cp {} workspace/device/nubia/NX669S/prebuilt/dtb/ \; 2>/dev/null || true
        
        ls -la workspace/device/nubia/NX669S/prebuilt/

    - name: Build TWRP
      run: |
        cd workspace
        export ALLOW_MISSING_DEPENDENCIES=true
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        ccache -M 8G
        source build/envsetup.sh
        lunch twrp_NX669S-eng
        mka recoveryimage -j$(nproc --all) 2>&1 | tee build.log

    - name: Find Output Files
      run: |
        cd workspace
        echo "=== Searching for output files ==="
        find out -name "*.img" -type f 2>/dev/null | head -20
        echo "=== Out directory ==="
        ls -la out/target/product/NX669S/ 2>/dev/null || echo "No product directory"

    - name: Upload recovery.img
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-recovery-NX669S
        path: workspace/out/target/product/NX669S/recovery.img
        if-no-files-found: warn

    - name: Upload vendor_boot.img
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-vendor_boot-NX669S
        path: workspace/out/target/product/NX669S/vendor_boot.img
        if-no-files-found: warn

    - name: Get Build Date
      id: date
      run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.date.outputs.date }}
        name: TWRP NX669S - ${{ steps.date.outputs.date }}
        body: |
          ## TWRP Recovery for Red Magic 6S Pro (NX669S)
          
          - **Branch:** ${{ github.event.inputs.MANIFEST_BRANCH }}
          - **Date:** ${{ steps.date.outputs.date }}
          - **Kernel:** NetHunter (built from source)
          
          ### Flash Instructions
          ```
          fastboot flash vendor_boot vendor_boot.img
          ```
          Or boot temporarily:
          ```
          fastboot boot recovery.img
          ```
        files: |
          workspace/out/target/product/NX669S/recovery.img
          workspace/out/target/product/NX669S/vendor_boot.img
        fail_on_unmatched_files: false
