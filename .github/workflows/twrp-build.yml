name: Build TWRP Recovery

on:
  workflow_dispatch:
    inputs:
      TWRP_BRANCH:
        description: 'TWRP Manifest Branch'
        required: true
        default: 'twrp-12.1'
        type: choice
        options:
          - twrp-12.1
          - twrp-11
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recoveryimage'
        type: choice
        options:
          - recoveryimage
          - bootimage
          - vendorbootimage

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Free Disk Space
      uses: jlumbroso/free-disk-space@main
      with:
        tool-cache: true
        android: false
        dotnet: true
        haskell: true
        large-packages: true
        docker-images: true
        swap-storage: true

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git-core gnupg flex bison build-essential zip curl zlib1g-dev \
          libc6-dev-i386 lib32ncurses-dev x11proto-core-dev libx11-dev \
          lib32z1-dev libgl1-mesa-dev libxml2-utils xsltproc unzip fontconfig \
          python3 python-is-python3 libncurses5 libncurses5-dev libssl-dev \
          bc cpio lzop ccache rsync schedtool squashfs-tools \
          liblz4-tool libzstd-dev

    - name: Setup repo tool
      run: |
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        echo "$HOME/bin" >> $GITHUB_PATH

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global color.ui false

    - name: Initialize TWRP Manifest
      run: |
        mkdir -p twrp
        cd twrp
        ~/bin/repo init --depth=1 -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b ${{ github.event.inputs.TWRP_BRANCH }}

    - name: Sync TWRP Source
      run: |
        cd twrp
        ~/bin/repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags --optimized-fetch --prune

    - name: Clone Device Tree
      run: |
        cd twrp
        git clone --depth=1 https://github.com/${{ github.repository }} device/nubia/NX669S

    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        max-size: 4G

    - name: Build TWRP Recovery
      run: |
        cd twrp
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        ccache -M 4G
        source build/envsetup.sh
        lunch twrp_NX669S-eng
        mka ${{ github.event.inputs.BUILD_TARGET }} -j$(nproc --all)

    - name: Find Build Output
      id: output
      run: |
        cd twrp/out/target/product/NX669S
        echo "Files in output directory:"
        ls -la *.img 2>/dev/null || echo "No img files"
        if [ -f recovery.img ]; then
          echo "recovery_img=recovery.img" >> $GITHUB_OUTPUT
        fi
        if [ -f vendor_boot.img ]; then
          echo "vendor_boot_img=vendor_boot.img" >> $GITHUB_OUTPUT
        fi
        if [ -f boot.img ]; then
          echo "boot_img=boot.img" >> $GITHUB_OUTPUT
        fi

    - name: Upload Recovery Image
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-NX669S-${{ github.event.inputs.TWRP_BRANCH }}-${{ github.run_number }}
        path: |
          twrp/out/target/product/NX669S/recovery.img
          twrp/out/target/product/NX669S/vendor_boot.img
          twrp/out/target/product/NX669S/boot.img
        if-no-files-found: warn

    - name: Create Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: twrp-${{ github.event.inputs.TWRP_BRANCH }}-${{ github.run_number }}
        name: TWRP Recovery for NX669S - Build ${{ github.run_number }}
        body: |
          ## TWRP Recovery for Red Magic 6S Pro (NX669S)
          
          **Build Information:**
          - TWRP Branch: ${{ github.event.inputs.TWRP_BRANCH }}
          - Build Target: ${{ github.event.inputs.BUILD_TARGET }}
          - Build Number: ${{ github.run_number }}
          
          **Device:**
          - Device: Red Magic 6S Pro
          - Codename: NX669S
          - Platform: lahaina (Snapdragon 888+)
          
          **Flash Instructions:**
          ```bash
          # Boot to bootloader
          adb reboot bootloader
          
          # Flash vendor_boot (for A/B devices)
          fastboot flash vendor_boot vendor_boot.img
          
          # Or boot temporarily
          fastboot boot recovery.img
          ```
        files: |
          twrp/out/target/product/NX669S/recovery.img
          twrp/out/target/product/NX669S/vendor_boot.img
          twrp/out/target/product/NX669S/boot.img
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
