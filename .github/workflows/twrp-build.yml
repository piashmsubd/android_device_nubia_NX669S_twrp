name: Build TWRP Recovery

on:
  workflow_dispatch:
    inputs:
      MANIFEST_BRANCH:
        description: 'TWRP Manifest Branch'
        required: true
        default: 'twrp-12.1'
        type: choice
        options:
          - twrp-12.1
          - twrp-11

jobs:
  build:
    name: Build TWRP by ${{ github.actor }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
    - name: Cleanup
      uses: rokibhasansagar/slimhub_actions@main

    - name: Setup Build Environment
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          bc bison build-essential ccache curl flex g++-multilib \
          gcc-multilib git gnupg gperf imagemagick lib32ncurses-dev \
          lib32readline-dev lib32z1-dev liblz4-tool libncurses5 \
          libncurses-dev libsdl1.2-dev libssl-dev libxml2 libxml2-utils \
          lzop pngcrush rsync schedtool squashfs-tools xsltproc zip \
          zlib1g-dev python3 python-is-python3 openjdk-11-jdk
        
    - name: Setup ccache
      uses: hendrikmuhs/ccache-action@v1.2
      with:
        max-size: 6G
        key: ccache-twrp-${{ github.event.inputs.MANIFEST_BRANCH }}

    - name: Install repo
      run: |
        mkdir -p ~/bin
        curl https://storage.googleapis.com/git-repo-downloads/repo > ~/bin/repo
        chmod a+x ~/bin/repo
        sudo ln -sf ~/bin/repo /usr/bin/repo

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Initialize repo
      run: |
        mkdir workspace && cd workspace
        repo init --depth=1 -u https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git -b ${{ github.event.inputs.MANIFEST_BRANCH }}

    - name: Sync Source
      run: |
        cd workspace
        repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags

    - name: Clone Device Tree
      run: |
        cd workspace
        git clone --depth=1 https://github.com/${{ github.repository }} -b main device/nubia/NX669S

    - name: Check Tree Structure
      run: |
        cd workspace
        if [ -d "device/nubia/NX669S/device/nubia/NX669S" ]; then
          echo "Fixing nested directory structure..."
          mv device/nubia/NX669S/device/nubia/NX669S/* device/nubia/NX669S/
          rm -rf device/nubia/NX669S/device
        fi
        ls -la device/nubia/NX669S/

    - name: Build TWRP
      run: |
        cd workspace
        export ALLOW_MISSING_DEPENDENCIES=true
        export USE_CCACHE=1
        export CCACHE_EXEC=/usr/bin/ccache
        ccache -M 6G
        source build/envsetup.sh
        lunch twrp_NX669S-eng
        mka recoveryimage -j$(nproc --all)

    - name: Upload recovery.img
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-recovery-NX669S
        path: workspace/out/target/product/NX669S/recovery.img
        if-no-files-found: warn

    - name: Upload vendor_boot.img
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-vendor_boot-NX669S
        path: workspace/out/target/product/NX669S/vendor_boot.img
        if-no-files-found: warn

    - name: Get Build Date
      id: date
      run: echo "date=$(date +'%Y%m%d')" >> $GITHUB_OUTPUT

    - name: Release
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.date.outputs.date }}
        name: TWRP NX669S - ${{ steps.date.outputs.date }}
        body: |
          ## TWRP Recovery for Red Magic 6S Pro (NX669S)
          
          - **Branch:** ${{ github.event.inputs.MANIFEST_BRANCH }}
          - **Date:** ${{ steps.date.outputs.date }}
          
          ### Flash Instructions
          ```
          fastboot flash vendor_boot vendor_boot.img
          ```
          Or boot temporarily:
          ```
          fastboot boot recovery.img
          ```
        files: |
          workspace/out/target/product/NX669S/recovery.img
          workspace/out/target/product/NX669S/vendor_boot.img
        fail_on_unmatched_files: false
