name: Build TWRP Recovery

on:
  workflow_dispatch:
    inputs:
      TWRP_BRANCH:
        description: 'TWRP Manifest Branch'
        required: true
        default: 'twrp-12.1'
        type: choice
        options:
          - twrp-12.1
          - twrp-11
      BUILD_TARGET:
        description: 'Build Target'
        required: true
        default: 'recoveryimage'
        type: choice
        options:
          - recoveryimage
          - bootimage
          - vendorbootimage

env:
  REPO_URL: https://github.com/minimal-manifest-twrp/platform_manifest_twrp_aosp.git
  DEVICE_TREE_URL: https://github.com/${{ github.repository }}
  DEVICE_PATH: device/nubia/NX669S
  DEVICE_NAME: NX669S

jobs:
  build:
    runs-on: ubuntu-22.04
    container:
      image: debian:bookworm
      options: --privileged
    permissions:
      contents: write

    steps:
    - name: Setup Debian Build Environment
      run: |
        dpkg --add-architecture i386
        apt-get update
        apt-get install -y \
          git gnupg flex bison gperf build-essential zip curl \
          zlib1g-dev zlib1g-dev:i386 gcc-multilib g++-multilib \
          libc6-dev-i386 libncurses5 libncurses5:i386 \
          lib32ncurses-dev libncurses5-dev x11proto-core-dev \
          libx11-dev:i386 libreadline-dev:i386 lib32z1-dev \
          libgl1-mesa-glx:i386 libgl1-mesa-dev libxml2-utils \
          xsltproc unzip fontconfig python3 python3-pip \
          libssl-dev imagemagick bc cpio lzop ccache rsync \
          schedtool squashfs-tools liblz4-tool libzstd-dev \
          wget openjdk-17-jdk ca-certificates procps sudo
        ln -sf /usr/bin/python3 /usr/bin/python
        git config --global --add safe.directory '*'
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"
        git config --global color.ui false

    - name: Setup repo tool
      run: |
        mkdir -p /root/bin
        curl -s https://storage.googleapis.com/git-repo-downloads/repo > /root/bin/repo
        chmod a+x /root/bin/repo

    - name: Free Disk Space
      run: |
        df -h
        rm -rf /usr/share/dotnet /usr/local/lib/android /opt/ghc || true
        apt-get clean
        df -h

    - name: Initialize TWRP Manifest
      run: |
        mkdir -p /twrp && cd /twrp
        /root/bin/repo init --depth=1 -u ${{ env.REPO_URL }} -b ${{ github.event.inputs.TWRP_BRANCH }}
      env:
        GIT_TERMINAL_PROMPT: 0

    - name: Sync TWRP Source
      run: |
        cd /twrp
        /root/bin/repo sync -c -j$(nproc --all) --force-sync --no-clone-bundle --no-tags --optimized-fetch --prune
      timeout-minutes: 60

    - name: Clone Device Tree
      run: |
        cd /twrp
        git clone --depth=1 ${{ env.DEVICE_TREE_URL }} ${{ env.DEVICE_PATH }}
        ls -la ${{ env.DEVICE_PATH }}/

    - name: Setup ccache
      run: |
        ccache -M 4G
        export USE_CCACHE=1
        export CCACHE_EXEC=$(which ccache)

    - name: Build TWRP Recovery
      run: |
        cd /twrp
        export USE_CCACHE=1
        export CCACHE_EXEC=$(which ccache)
        export ALLOW_MISSING_DEPENDENCIES=true
        source build/envsetup.sh
        lunch twrp_${{ env.DEVICE_NAME }}-eng
        mka ${{ github.event.inputs.BUILD_TARGET }} -j$(nproc --all)
      timeout-minutes: 180

    - name: Check Build Output
      id: output
      run: |
        cd /twrp/out/target/product/${{ env.DEVICE_NAME }}
        echo "=== Build Output Files ==="
        ls -la *.img 2>/dev/null || echo "No img files found"
        ls -la
        
        if [ -f recovery.img ]; then
          cp recovery.img /github/workspace/
          echo "recovery=true" >> $GITHUB_OUTPUT
        fi
        if [ -f vendor_boot.img ]; then
          cp vendor_boot.img /github/workspace/
          echo "vendor_boot=true" >> $GITHUB_OUTPUT
        fi
        if [ -f boot.img ]; then
          cp boot.img /github/workspace/
          echo "boot=true" >> $GITHUB_OUTPUT
        fi

    - name: Upload Recovery Image
      uses: actions/upload-artifact@v4
      with:
        name: TWRP-${{ env.DEVICE_NAME }}-${{ github.event.inputs.TWRP_BRANCH }}-${{ github.run_number }}
        path: |
          *.img
        if-no-files-found: warn

    - name: Create Release
      if: success()
      uses: softprops/action-gh-release@v1
      with:
        tag_name: twrp-${{ github.event.inputs.TWRP_BRANCH }}-${{ github.run_number }}
        name: TWRP Recovery for ${{ env.DEVICE_NAME }} - Build ${{ github.run_number }}
        body: |
          ## TWRP Recovery for Red Magic 6S Pro (${{ env.DEVICE_NAME }})
          
          **Build Information:**
          - TWRP Branch: ${{ github.event.inputs.TWRP_BRANCH }}
          - Build Target: ${{ github.event.inputs.BUILD_TARGET }}
          - Build Number: ${{ github.run_number }}
          - Build System: Debian Bookworm
          
          **Device:**
          - Device: Red Magic 6S Pro
          - Codename: ${{ env.DEVICE_NAME }}
          - Platform: lahaina (Snapdragon 888+)
          
          **Flash Instructions:**
          ```bash
          # Boot to bootloader
          adb reboot bootloader
          
          # Flash vendor_boot (for A/B devices)
          fastboot flash vendor_boot vendor_boot.img
          
          # Or boot temporarily
          fastboot boot recovery.img
          ```
        files: |
          *.img
        fail_on_unmatched_files: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
